{"version":3,"file":"workgroup_size.spec.js","names":["description","makeTestGroup","iterRange","GPUTest","g","checkResults","sizeX","sizeY","sizeZ","numWGs","data","totalInvocations","i","wgx_data","wgy_data","wgz_data","total_data","msg","Error","undefined","test","desc","params","u","combine","beginSubcases","fn","t","maxComputeWorkgroupSizeX","maxComputeWorkgroupSizeY","maxComputeWorkgroupSizeZ","maxComputeInvocationsPerWorkgroup","device","limits","skipIf","wgx","wgy","wgz","code","pipeline","createComputePipeline","layout","compute","module","createShaderModule","entryPoint","numWorkgroups","buffer","makeBufferWithContents","Uint32Array","_i","GPUBufferUsage","STORAGE","COPY_SRC","COPY_DST","bg","createBindGroup","getBindGroupLayout","entries","binding","resource","encoder","globalThis","_TRAMPOLINE_","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","queue","submit","finish","bufferReadback","readGPUBufferRangeTyped","srcByteOffset","type","typedLength","method","expectOK"],"sources":["../../../../../src/webgpu/shader/execution/shader_io/workgroup_size.spec.ts"],"sourcesContent":["/**\n* AUTO-GENERATED - DO NOT EDIT. Source: https://github.com/gpuweb/cts\n**/export const description = `Test that workgroup size is set correctly`;import { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { iterRange } from '../../../../common/util/util.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nexport const g = makeTestGroup(GPUTest);\n\nfunction checkResults(\nsizeX,\nsizeY,\nsizeZ,\nnumWGs,\ndata)\n{\n  const totalInvocations = sizeX * sizeY * sizeZ;\n  for (let i = 0; i < numWGs; i++) {\n    const wgx_data = data[4 * i + 0];\n    const wgy_data = data[4 * i + 1];\n    const wgz_data = data[4 * i + 2];\n    const total_data = data[4 * i + 3];\n    if (wgx_data !== sizeX) {\n      let msg = `Incorrect workgroup size x dimension for wg ${i}:\\n`;\n      msg += `- expected: ${wgx_data}\\n`;\n      msg += `- got:      ${sizeX}`;\n      return Error(msg);\n    }\n    if (wgy_data !== sizeY) {\n      let msg = `Incorrect workgroup size y dimension for wg ${i}:\\n`;\n      msg += `- expected: ${wgy_data}\\n`;\n      msg += `- got:      ${sizeY}`;\n      return Error(msg);\n    }\n    if (wgz_data !== sizeZ) {\n      let msg = `Incorrect workgroup size y dimension for wg ${i}:\\n`;\n      msg += `- expected: ${wgz_data}\\n`;\n      msg += `- got:      ${sizeZ}`;\n      return Error(msg);\n    }\n    if (total_data !== totalInvocations) {\n      let msg = `Incorrect workgroup total invocations for wg ${i}:\\n`;\n      msg += `- expected: ${total_data}\\n`;\n      msg += `- got:      ${totalInvocations}`;\n      return Error(msg);\n    }\n  }\n  return undefined;\n}\n\ng.test('workgroup_size').\ndesc(`Test workgroup size is set correctly`).\nparams((u) =>\nu.\ncombine('wgx', [1, 3, 4, 8, 11, 16, 51, 64, 128, 256]).\ncombine('wgy', [1, 3, 4, 8, 16, 51, 64, 256]).\ncombine('wgz', [1, 3, 11, 16, 128, 256]).\nbeginSubcases()\n).\nfn(async (t) => {\n  const {\n    maxComputeWorkgroupSizeX,\n    maxComputeWorkgroupSizeY,\n    maxComputeWorkgroupSizeZ,\n    maxComputeInvocationsPerWorkgroup\n  } = t.device.limits;\n  t.skipIf(\n    t.params.wgx > maxComputeWorkgroupSizeX,\n    `workgroup size x: ${t.params.wgx} > limit: ${maxComputeWorkgroupSizeX}`\n  );\n  t.skipIf(\n    t.params.wgy > maxComputeWorkgroupSizeY,\n    `workgroup size x: ${t.params.wgy} > limit: ${maxComputeWorkgroupSizeY}`\n  );\n  t.skipIf(\n    t.params.wgz > maxComputeWorkgroupSizeZ,\n    `workgroup size x: ${t.params.wgz} > limit: ${maxComputeWorkgroupSizeZ}`\n  );\n  const totalInvocations = t.params.wgx * t.params.wgy * t.params.wgz;\n  t.skipIf(\n    totalInvocations > maxComputeInvocationsPerWorkgroup,\n    `workgroup size: ${totalInvocations} > limit: ${maxComputeInvocationsPerWorkgroup}`\n  );\n\n  const code = `\nstruct Values {\n  x : atomic<u32>,\n  y : atomic<u32>,\n  z : atomic<u32>,\n  total : atomic<u32>,\n}\n\n@group(0) @binding(0)\nvar<storage, read_write> v : array<Values>;\n\n@compute @workgroup_size(${t.params.wgx}, ${t.params.wgy}, ${t.params.wgz})\nfn main(@builtin(local_invocation_id) lid : vec3u,\n        @builtin(workgroup_id) wgid : vec3u) {\n  atomicMax(&v[wgid.x].x, lid.x + 1);\n  atomicMax(&v[wgid.x].y, lid.y + 1);\n  atomicMax(&v[wgid.x].z, lid.z + 1);\n  atomicAdd(&v[wgid.x].total, 1);\n}`;\n\n  const pipeline = t.device.createComputePipeline({\n    layout: 'auto',\n    compute: {\n      module: t.device.createShaderModule({\n        code\n      }),\n      entryPoint: 'main'\n    }\n  });\n\n  const numWorkgroups = totalInvocations < 256 ? 5 : 3;\n  const buffer = t.makeBufferWithContents(\n    new Uint32Array([...iterRange(numWorkgroups * 4, (_i) => 0)]),\n    GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC | GPUBufferUsage.COPY_DST\n  );\n\n  const bg = t.device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [\n    {\n      binding: 0,\n      resource: {\n        buffer\n      }\n    }]\n\n  });\n\n  const encoder = globalThis._TRAMPOLINE_(\"createCommandEncoder\", t.device, t.device.createCommandEncoder, [], () => t.device.createCommandEncoder());\n  const pass = encoder.beginComputePass();\n  pass.setPipeline(pipeline);\n  pass.setBindGroup(0, bg);\n  pass.dispatchWorkgroups(numWorkgroups, 1, 1);\n  pass.end();\n  globalThis._TRAMPOLINE_(\"submit\", t, t.queue.submit, [[encoder.finish()]], () => t.queue.submit([encoder.finish()]));\n\n  const bufferReadback = await t.readGPUBufferRangeTyped(buffer, {\n    srcByteOffset: 0,\n    type: Uint32Array,\n    typedLength: 4 * numWorkgroups,\n    method: 'copy'\n  });\n  const data = bufferReadback.data;\n\n  t.expectOK(checkResults(t.params.wgx, t.params.wgy, t.params.wgz, numWorkgroups, data));\n});"],"mappings":"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","ignoreList":[]}