{"version":3,"file":"case_cache.js","names":["dataCache","unreachable","BinaryStream","deserializeComparator","serializeComparator","MatrixValue","VectorValue","deserializeValue","isScalarValue","serializeValue","FPInterval","deserializeFPInterval","serializeFPInterval","flatten2DArray","unflatten2DArray","isComparator","SerializedExpectationKind","serializeExpectation","s","e","writeU8","Value","Interval","Array","cols","length","rows","Interval2DArray","writeU16","writeArray","Interval1DArray","Comparator","deserializeExpectation","kind","readU8","readArray","readU16","serializeCase","c","writeCond","input","if_true","if_false","expected","deserializeCase","readCond","CaseCache","constructor","name","builders","path","get","data","fetch","build","built","cases","Promise","resolve","serialize","maxSize","stream","ArrayBuffer","writeU32","Object","keys","writeString","buffer","deserialize","array","casesByName","numRecords","readU32","i","readString","makeCaseCache"],"sources":["../../../../../src/webgpu/shader/execution/expression/case_cache.ts"],"sourcesContent":["/**\n* AUTO-GENERATED - DO NOT EDIT. Source: https://github.com/gpuweb/cts\n**/import { dataCache } from '../../../../common/framework/data_cache.js';import { unreachable } from '../../../../common/util/util.js';import BinaryStream from '../../../util/binary_stream.js';\nimport { deserializeComparator, serializeComparator } from '../../../util/compare.js';\nimport {\n  MatrixValue,\n\n  VectorValue,\n  deserializeValue,\n  isScalarValue,\n  serializeValue } from\n'../../../util/conversion.js';\nimport {\n  FPInterval,\n  deserializeFPInterval,\n  serializeFPInterval } from\n'../../../util/floating_point.js';\nimport { flatten2DArray, unflatten2DArray } from '../../../util/math.js';\n\n\nimport { isComparator } from './expectation.js';var\n\nSerializedExpectationKind = /*#__PURE__*/function (SerializedExpectationKind) {SerializedExpectationKind[SerializedExpectationKind[\"Value\"] = 0] = \"Value\";SerializedExpectationKind[SerializedExpectationKind[\"Interval\"] = 1] = \"Interval\";SerializedExpectationKind[SerializedExpectationKind[\"Interval1DArray\"] = 2] = \"Interval1DArray\";SerializedExpectationKind[SerializedExpectationKind[\"Interval2DArray\"] = 3] = \"Interval2DArray\";SerializedExpectationKind[SerializedExpectationKind[\"Array\"] = 4] = \"Array\";SerializedExpectationKind[SerializedExpectationKind[\"Comparator\"] = 5] = \"Comparator\";return SerializedExpectationKind;}(SerializedExpectationKind || {});\n\n\n\n\n\n\n\n\n/** serializeExpectation() serializes an Expectation to a BinaryStream */\nexport function serializeExpectation(s, e) {\n  if (isScalarValue(e) || e instanceof VectorValue || e instanceof MatrixValue) {\n    s.writeU8(SerializedExpectationKind.Value);\n    serializeValue(s, e);\n    return;\n  }\n  if (e instanceof FPInterval) {\n    s.writeU8(SerializedExpectationKind.Interval);\n    serializeFPInterval(s, e);\n    return;\n  }\n  if (e instanceof Array) {\n    if (e[0] instanceof Array) {\n      e = e;\n      const cols = e.length;\n      const rows = e[0].length;\n      s.writeU8(SerializedExpectationKind.Interval2DArray);\n      s.writeU16(cols);\n      s.writeU16(rows);\n      s.writeArray(flatten2DArray(e), serializeFPInterval);\n    } else {\n      e = e;\n      s.writeU8(SerializedExpectationKind.Interval1DArray);\n      s.writeArray(e, serializeFPInterval);\n    }\n    return;\n  }\n  if (isComparator(e)) {\n    s.writeU8(SerializedExpectationKind.Comparator);\n    serializeComparator(s, e);\n    return;\n  }\n  unreachable(`cannot serialize Expectation ${e}`);\n}\n\n/** deserializeExpectation() deserializes an Expectation from a BinaryStream */\nexport function deserializeExpectation(s) {\n  const kind = s.readU8();\n  switch (kind) {\n    case SerializedExpectationKind.Value:{\n        return deserializeValue(s);\n      }\n    case SerializedExpectationKind.Interval:{\n        return deserializeFPInterval(s);\n      }\n    case SerializedExpectationKind.Interval1DArray:{\n        return s.readArray(deserializeFPInterval);\n      }\n    case SerializedExpectationKind.Interval2DArray:{\n        const cols = s.readU16();\n        const rows = s.readU16();\n        return unflatten2DArray(s.readArray(deserializeFPInterval), cols, rows);\n      }\n    case SerializedExpectationKind.Comparator:{\n        return deserializeComparator(s);\n      }\n    default:{\n        unreachable(`invalid serialized expectation kind: ${kind}`);\n      }\n  }\n}\n\n/** serializeCase() serializes a Case to a BinaryStream */\nexport function serializeCase(s, c) {\n  s.writeCond(c.input instanceof Array, {\n    if_true: () => {\n      // c.input is array\n      s.writeArray(c.input, serializeValue);\n    },\n    if_false: () => {\n      // c.input is not array\n      serializeValue(s, c.input);\n    }\n  });\n  serializeExpectation(s, c.expected);\n}\n\n/** deserializeCase() deserializes a Case from a BinaryStream */\nexport function deserializeCase(s) {\n  const input = s.readCond({\n    if_true: () => {\n      // c.input is array\n      return s.readArray(deserializeValue);\n    },\n    if_false: () => {\n      // c.input is not array\n      return deserializeValue(s);\n    }\n  });\n  const expected = deserializeExpectation(s);\n  return { input, expected };\n}\n\n/** CaseListBuilder is a function that builds a list of cases, Case[] */\n\n\n/**\n * CaseCache is a cache of Case[].\n * CaseCache implements the Cacheable interface, so the cases can be pre-built\n * and stored in the data cache, reducing computation costs at CTS runtime.\n */\nexport class CaseCache {\n  /**\n   * Constructor\n   * @param name the name of the cache. This must be globally unique.\n   * @param builders a Record of case-list name to case-list builder.\n   */\n  constructor(name, builders) {\n    this.path = `webgpu/shader/execution/${name}.bin`;\n    this.builders = builders;\n  }\n\n  /** get() returns the list of cases with the given name */\n  async get(name) {\n    const data = await dataCache.fetch(this);\n    return data[name];\n  }\n\n  /**\n   * build() implements the Cacheable.build interface.\n   * @returns the data.\n   */\n  build() {\n    const built = {};\n    for (const name in this.builders) {\n      const cases = this.builders[name]();\n      built[name] = cases;\n    }\n    return Promise.resolve(built);\n  }\n\n  /**\n   * serialize() implements the Cacheable.serialize interface.\n   * @returns the serialized data.\n   */\n  serialize(data) {\n    const maxSize = 32 << 20; // 32MB - max size for a file\n    const stream = new BinaryStream(new ArrayBuffer(maxSize));\n    stream.writeU32(Object.keys(data).length);\n    for (const name in data) {\n      stream.writeString(name);\n      stream.writeArray(data[name], serializeCase);\n    }\n    return stream.buffer();\n  }\n\n  /**\n   * deserialize() implements the Cacheable.deserialize interface.\n   * @returns the deserialize data.\n   */\n  deserialize(array) {\n    const s = new BinaryStream(array.buffer);\n    const casesByName = {};\n    const numRecords = s.readU32();\n    for (let i = 0; i < numRecords; i++) {\n      const name = s.readString();\n      const cases = s.readArray(deserializeCase);\n      casesByName[name] = cases;\n    }\n    return casesByName;\n  }\n\n\n\n}\n\nexport function makeCaseCache(name, builders) {\n  return new CaseCache(name, builders);\n}"],"mappings":"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","ignoreList":[]}