{"version":3,"file":"shader_validation_test.js","names":["keysOf","ErrorWithExtra","GPUTest","ShaderValidationTest","expectCompileResult","expectedResult","code","shaderModule","expectGPUError","device","createShaderModule","error","eventualAsyncExpectation","compilationInfo","getCompilationInfo","messagesLog","messages","map","m","lineNum","linePos","type","message","join","extra","some","rec","validationFailed","debug","expectCompileWarning","expectWarning","expectPipelineResult","args","phonies","statements","undefined","push","constants","c","reference","createComputePipeline","layout","compute","module","entryPoint","wrapInEntryPoint","enabledExtensions","enableDirectives","x"],"sources":["../../../../src/webgpu/shader/validation/shader_validation_test.ts"],"sourcesContent":["/**\n* AUTO-GENERATED - DO NOT EDIT. Source: https://github.com/gpuweb/cts\n**/import { keysOf } from '../../../common/util/data_tables.js';import { ErrorWithExtra } from '../../../common/util/util.js';import { GPUTest } from '../../gpu_test.js';\n\n/**\n * Base fixture for WGSL shader validation tests.\n */\nexport class ShaderValidationTest extends GPUTest {\n  /**\n   * Add a test expectation for whether a createShaderModule call succeeds or not.\n   *\n   * @example\n   * ```ts\n   * t.expectCompileResult(true, `wgsl code`); // Expect success\n   * t.expectCompileResult(false, `wgsl code`); // Expect validation error with any error string\n   * ```\n   */\n  expectCompileResult(expectedResult, code) {\n    let shaderModule;\n    this.expectGPUError(\n      'validation',\n      () => {\n        shaderModule = this.device.createShaderModule({ code });\n      },\n      expectedResult !== true\n    );\n\n    const error = new ErrorWithExtra('', () => ({ shaderModule }));\n    this.eventualAsyncExpectation(async () => {\n      const compilationInfo = await shaderModule.getCompilationInfo();\n\n      // MAINTENANCE_TODO: Pretty-print error messages with source context.\n      const messagesLog =\n      compilationInfo.messages.\n      map((m) => `${m.lineNum}:${m.linePos}: ${m.type}: ${m.message}`).\n      join('\\n') +\n      '\\n\\n---- shader ----\\n' +\n      code;\n      error.extra.compilationInfo = compilationInfo;\n\n      if (compilationInfo.messages.some((m) => m.type === 'error')) {\n        if (expectedResult) {\n          error.message = `Unexpected compilationInfo 'error' message.\\n` + messagesLog;\n          this.rec.validationFailed(error);\n        } else {\n          error.message = `Found expected compilationInfo 'error' message.\\n` + messagesLog;\n          this.rec.debug(error);\n        }\n      } else {\n        if (!expectedResult) {\n          error.message = `Missing expected compilationInfo 'error' message.\\n` + messagesLog;\n          this.rec.validationFailed(error);\n        } else {\n          error.message = `No compilationInfo 'error' messages, as expected.\\n` + messagesLog;\n          this.rec.debug(error);\n        }\n      }\n    });\n  }\n\n  /**\n   * Add a test expectation for whether a createShaderModule call issues a warning.\n   *\n   * @example\n   * ```ts\n   * t.expectCompileWarning(true, `wgsl code`); // Expect compile success and any warning message\n   * t.expectCompileWarning(false, `wgsl code`); // Expect compile success and no warning messages\n   * ```\n   */\n  expectCompileWarning(expectWarning, code) {\n    let shaderModule;\n    this.expectGPUError(\n      'validation',\n      () => {\n        shaderModule = this.device.createShaderModule({ code });\n      },\n      false\n    );\n\n    const error = new ErrorWithExtra('', () => ({ shaderModule }));\n    this.eventualAsyncExpectation(async () => {\n      const compilationInfo = await shaderModule.getCompilationInfo();\n\n      // MAINTENANCE_TODO: Pretty-print error messages with source context.\n      const messagesLog = compilationInfo.messages.\n      map((m) => `${m.lineNum}:${m.linePos}: ${m.type}: ${m.message}`).\n      join('\\n');\n      error.extra.compilationInfo = compilationInfo;\n\n      if (compilationInfo.messages.some((m) => m.type === 'warning')) {\n        if (expectWarning) {\n          error.message = `No 'warning' message as expected.\\n` + messagesLog;\n          this.rec.debug(error);\n        } else {\n          error.message = `Missing expected compilationInfo 'warning' message.\\n` + messagesLog;\n          this.rec.validationFailed(error);\n        }\n      } else {\n        if (expectWarning) {\n          error.message = `Missing expected 'warning' message.\\n` + messagesLog;\n          this.rec.validationFailed(error);\n        } else {\n          error.message = `Found a 'warning' message as expected.\\n` + messagesLog;\n          this.rec.debug(error);\n        }\n      }\n    });\n  }\n\n  /**\n   * Add a test expectation for whether a createComputePipeline call succeeds or not.\n   */\n  expectPipelineResult(args)\n\n\n\n\n\n\n\n\n\n\n  {\n    const phonies = [];\n\n    if (args.statements !== undefined) {\n      phonies.push(...args.statements);\n    }\n    if (args.constants !== undefined) {\n      phonies.push(...keysOf(args.constants).map((c) => `_ = ${c};`));\n    }\n    if (args.reference !== undefined) {\n      phonies.push(...args.reference.map((c) => `_ = ${c};`));\n    }\n\n    const code =\n    args.code +\n    `\n@compute @workgroup_size(1)\nfn main() {\n  ${phonies.join('\\n')}\n}`;\n\n    let shaderModule;\n    this.expectGPUError(\n      'validation',\n      () => {\n        shaderModule = this.device.createShaderModule({ code });\n      },\n      false\n    );\n\n    this.expectGPUError(\n      'validation',\n      () => {\n        this.device.createComputePipeline({\n          layout: 'auto',\n          compute: { module: shaderModule, entryPoint: 'main', constants: args.constants }\n        });\n      },\n      !args.expectedResult\n    );\n  }\n\n  /**\n   * Wraps the code fragment into an entry point.\n   *\n   * @example\n   * ```ts\n   * t.wrapInEntryPoint(`var i = 0;`);\n   * ```\n   */\n  wrapInEntryPoint(code, enabledExtensions = []) {\n    const enableDirectives = enabledExtensions.map((x) => `enable ${x};`).join('\\n      ');\n\n    return `\n      ${enableDirectives}\n\n      @compute @workgroup_size(1)\n      fn main() {\n        ${code}\n      }`;\n  }\n}"],"mappings":"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","ignoreList":[]}