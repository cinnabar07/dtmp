{"version":3,"file":"worker.js","names":["getGPU","setDefaultRequestAdapterOptions","assert","objectEquals","iterRange","basicTest","adapter","globalThis","_TRAMPOLINE_","requestAdapter","device","requestDevice","kOffset","pipeline","createComputePipeline","layout","compute","module","createShaderModule","code","entryPoint","kNumElements","kBufferSize","buffer","createBuffer","size","usage","GPUBufferUsage","STORAGE","COPY_SRC","resultBuffer","MAP_READ","COPY_DST","bindGroup","createBindGroup","getBindGroupLayout","entries","binding","resource","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","copyBufferToBuffer","queue","submit","finish","expected","Uint32Array","x","mapAsync","GPUMapMode","READ","actual","getMappedRange","destroy","reportTestResults","ev","defaultRequestAdapterOptions","data","error","undefined","err","toString","postMessage","self","onmessage","call","source","onconnect","event","port","ports"],"sources":["../../../../src/webgpu/web_platform/worker/worker.ts"],"sourcesContent":["/**\n* AUTO-GENERATED - DO NOT EDIT. Source: https://github.com/gpuweb/cts\n**/import { getGPU, setDefaultRequestAdapterOptions } from '../../../common/util/navigator_gpu.js';import { assert, objectEquals, iterRange } from '../../../common/util/util.js';\n// Should be WorkerGlobalScope, but importing lib \"webworker\" conflicts with lib \"dom\".\n\n\n\nasync function basicTest() {\n  const adapter = await globalThis._TRAMPOLINE_(\"requestAdapter\", getGPU(null), getGPU(null).requestAdapter, [], () => getGPU(null).requestAdapter());\n  assert(adapter !== null, 'Failed to get adapter.');\n\n\n  const device = await globalThis._TRAMPOLINE_(\"requestDevice\", adapter, adapter.requestDevice, [], () => adapter.requestDevice());\n  assert(device !== null, 'Failed to get device.');\n\n  const kOffset = 1230000;\n  const pipeline = device.createComputePipeline({\n    layout: 'auto',\n    compute: {\n      module: device.createShaderModule({\n        code: `\n          struct Buffer { data: array<u32>, };\n\n          @group(0) @binding(0) var<storage, read_write> buffer: Buffer;\n          @compute @workgroup_size(1u) fn main(\n              @builtin(global_invocation_id) id: vec3<u32>) {\n            buffer.data[id.x] = id.x + ${kOffset}u;\n          }\n        `\n      }),\n      entryPoint: 'main'\n    }\n  });\n\n  const kNumElements = 64;\n  const kBufferSize = kNumElements * 4;\n\n  const buffer = globalThis._TRAMPOLINE_(\"createBuffer\", device, device.createBuffer, [{\n    size: kBufferSize,\n    usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC\n  }], () => device.createBuffer({ size: kBufferSize, usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC }));\n\n\n  const resultBuffer = globalThis._TRAMPOLINE_(\"createBuffer\", device, device.createBuffer, [{\n    size: kBufferSize,\n    usage: GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST\n  }], () => device.createBuffer({ size: kBufferSize, usage: GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST }));\n\n  const bindGroup = device.createBindGroup({\n    layout: pipeline.getBindGroupLayout(0),\n    entries: [{ binding: 0, resource: { buffer } }]\n  });\n\n  const encoder = globalThis._TRAMPOLINE_(\"createCommandEncoder\", device, device.createCommandEncoder, [], () => device.createCommandEncoder());\n\n  const pass = encoder.beginComputePass();\n  pass.setPipeline(pipeline);\n  pass.setBindGroup(0, bindGroup);\n  pass.dispatchWorkgroups(kNumElements);\n  pass.end();\n\n  encoder.copyBufferToBuffer(buffer, 0, resultBuffer, 0, kBufferSize);\n\n  globalThis._TRAMPOLINE_(\"submit\", device, device.queue.submit, [[encoder.finish()]], () => device.queue.submit([encoder.finish()]));\n\n  const expected = new Uint32Array([...iterRange(kNumElements, (x) => x + kOffset)]);\n\n  await globalThis._TRAMPOLINE_(\"mapAsync\", resultBuffer, resultBuffer.mapAsync, [GPUMapMode.READ], () => resultBuffer.mapAsync(GPUMapMode.READ));\n  const actual = new Uint32Array(resultBuffer.getMappedRange());\n\n  assert(objectEquals(actual, expected), 'compute pipeline ran');\n\n  globalThis._TRAMPOLINE_(\"destroy\", resultBuffer, resultBuffer.destroy, [], () => resultBuffer.destroy());\n  globalThis._TRAMPOLINE_(\"destroy\", buffer, buffer.destroy, [], () => buffer.destroy());\n  globalThis._TRAMPOLINE_(\"destroy\", device, device.destroy, [], () => device.destroy());\n}\n\nasync function reportTestResults(ev) {\n  const defaultRequestAdapterOptions =\n  ev.data.defaultRequestAdapterOptions;\n  setDefaultRequestAdapterOptions(defaultRequestAdapterOptions);\n\n  let error = undefined;\n  try {\n    await basicTest();\n  } catch (err) {\n    error = err.toString();\n  }\n  this.postMessage({ error });\n}\n\nself.onmessage = (ev) => {\n  void reportTestResults.call(ev.source || self, ev);\n};\n\nself.onconnect = (event) => {\n  const port = event.ports[0];\n\n  port.onmessage = (ev) => {\n    void reportTestResults.call(port, ev);\n  };\n};"],"mappings":"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","ignoreList":[]}