{"version":3,"file":"by_ds_test.js","names":["assert","kTextureFormatInfo","virtualMipSize","makeFullscreenVertexModule","device","createShaderModule","code","getDepthTestEqualPipeline","t","format","sampleCount","expected","createRenderPipeline","layout","vertex","entryPoint","module","fragment","targets","depthStencil","depthCompare","depthWriteEnabled","primitive","topology","multisample","count","getStencilTestEqualPipeline","stencilFront","compare","stencilBack","checkContents","type","params","texture","state","subresourceRange","formatInfo","dimension","viewDescriptor","generateTextureViewDescriptorsForRendering","baseMipLevel","undefined","width","height","textureWidth","textureHeight","renderTexture","createTextureTracked","size","usage","GPUTextureUsage","RENDER_ATTACHMENT","COPY_SRC","resolveTexture","resolveTarget","createView","commandEncoder","globalThis","_TRAMPOLINE_","createCommandEncoder","pushDebugGroup","pass","beginRenderPass","colorAttachments","view","clearValue","loadOp","storeOp","depthStencilAttachment","depthLoadOp","depth","depthStoreOp","stencilLoadOp","stencil","stencilStoreOp","expectedDepth","stateToTexelComponents","Depth","setPipeline","expectedStencil","Stencil","setStencilReference","draw","end","popDebugGroup","queue","submit","finish","expectSingleColor","exp","R","checkContentsByDepthTest","args","checkContentsByStencilTest"],"sources":["../../../../../../src/webgpu/api/operation/resource_init/check_texture/by_ds_test.ts"],"sourcesContent":["/**\n* AUTO-GENERATED - DO NOT EDIT. Source: https://github.com/gpuweb/cts\n**/import { assert } from '../../../../../common/util/util.js';import { kTextureFormatInfo } from '../../../../format_info.js';\nimport { virtualMipSize } from '../../../../util/texture/base.js';\n\n\n\nfunction makeFullscreenVertexModule(device) {\n  return device.createShaderModule({\n    code: `\n    @vertex\n    fn main(@builtin(vertex_index) VertexIndex : u32)\n         -> @builtin(position) vec4<f32> {\n      var pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(\n        vec2<f32>(-1.0, -3.0),\n        vec2<f32>( 3.0,  1.0),\n        vec2<f32>(-1.0,  1.0));\n      return vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n    }\n    `\n  });\n}\n\nfunction getDepthTestEqualPipeline(\nt,\nformat,\nsampleCount,\nexpected)\n{\n  return t.device.createRenderPipeline({\n    layout: 'auto',\n    vertex: {\n      entryPoint: 'main',\n      module: makeFullscreenVertexModule(t.device)\n    },\n    fragment: {\n      entryPoint: 'main',\n      module: t.device.createShaderModule({\n        code: `\n        struct Outputs {\n          @builtin(frag_depth) FragDepth : f32,\n          @location(0) outSuccess : f32,\n        };\n\n        @fragment\n        fn main() -> Outputs {\n          var output : Outputs;\n          output.FragDepth = f32(${expected});\n          output.outSuccess = 1.0;\n          return output;\n        }\n        `\n      }),\n      targets: [{ format: 'r8unorm' }]\n    },\n    depthStencil: {\n      format,\n      depthCompare: 'equal',\n      depthWriteEnabled: false\n    },\n    primitive: { topology: 'triangle-list' },\n    multisample: { count: sampleCount }\n  });\n}\n\nfunction getStencilTestEqualPipeline(\nt,\nformat,\nsampleCount)\n{\n  return t.device.createRenderPipeline({\n    layout: 'auto',\n    vertex: {\n      entryPoint: 'main',\n      module: makeFullscreenVertexModule(t.device)\n    },\n    fragment: {\n      entryPoint: 'main',\n      module: t.device.createShaderModule({\n        code: `\n        @fragment\n        fn main() -> @location(0) f32 {\n          return 1.0;\n        }\n        `\n      }),\n      targets: [{ format: 'r8unorm' }]\n    },\n    depthStencil: {\n      depthWriteEnabled: false,\n      depthCompare: 'always',\n      format,\n      stencilFront: { compare: 'equal' },\n      stencilBack: { compare: 'equal' }\n    },\n    primitive: { topology: 'triangle-list' },\n    multisample: { count: sampleCount }\n  });\n}\n\nconst checkContents = (\ntype,\nt,\nparams,\ntexture,\nstate,\nsubresourceRange) =>\n{\n  const formatInfo = kTextureFormatInfo[params.format];\n\n  assert(params.dimension === '2d');\n  for (const viewDescriptor of t.generateTextureViewDescriptorsForRendering(\n    'all',\n    subresourceRange\n  )) {\n    assert(viewDescriptor.baseMipLevel !== undefined);\n    const [width, height] = virtualMipSize(\n      params.dimension,\n      [t.textureWidth, t.textureHeight, 1],\n      viewDescriptor.baseMipLevel\n    );\n\n    const renderTexture = t.createTextureTracked({\n      size: [width, height, 1],\n      format: 'r8unorm',\n      usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC,\n      sampleCount: params.sampleCount\n    });\n\n    let resolveTexture = undefined;\n    let resolveTarget = undefined;\n    if (params.sampleCount > 1) {\n      resolveTexture = t.createTextureTracked({\n        size: [width, height, 1],\n        format: 'r8unorm',\n        usage: GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.COPY_SRC\n      });\n      resolveTarget = resolveTexture.createView();\n    }\n\n    const commandEncoder = globalThis._TRAMPOLINE_(\"createCommandEncoder\", t.device, t.device.createCommandEncoder, [], () => t.device.createCommandEncoder());\n    commandEncoder.pushDebugGroup('checkContentsWithDepthStencil');\n\n    const pass = commandEncoder.beginRenderPass({\n      colorAttachments: [\n      {\n        view: renderTexture.createView(),\n        resolveTarget,\n        clearValue: [0, 0, 0, 0],\n        loadOp: 'load',\n        storeOp: 'store'\n      }],\n\n      depthStencilAttachment: {\n        view: texture.createView(viewDescriptor),\n        depthLoadOp: formatInfo.depth ? 'load' : undefined,\n        depthStoreOp: formatInfo.depth ? 'store' : undefined,\n        stencilLoadOp: formatInfo.stencil ? 'load' : undefined,\n        stencilStoreOp: formatInfo.stencil ? 'store' : undefined\n      }\n    });\n\n    switch (type) {\n      case 'depth':{\n          const expectedDepth = t.stateToTexelComponents[state].Depth;\n          assert(expectedDepth !== undefined);\n\n          pass.setPipeline(\n            getDepthTestEqualPipeline(t, params.format, params.sampleCount, expectedDepth)\n          );\n          break;\n        }\n\n      case 'stencil':{\n          const expectedStencil = t.stateToTexelComponents[state].Stencil;\n          assert(expectedStencil !== undefined);\n\n          pass.setPipeline(getStencilTestEqualPipeline(t, params.format, params.sampleCount));\n          pass.setStencilReference(expectedStencil);\n          break;\n        }\n    }\n\n    pass.draw(3);\n    pass.end();\n\n    commandEncoder.popDebugGroup();\n    globalThis._TRAMPOLINE_(\"submit\", t, t.queue.submit, [[commandEncoder.finish()]], () => t.queue.submit([commandEncoder.finish()]));\n\n    t.expectSingleColor(resolveTexture || renderTexture, 'r8unorm', {\n      size: [width, height, 1],\n      exp: { R: 1 }\n    });\n  }\n};\n\nexport const checkContentsByDepthTest = (...args) =>\ncheckContents('depth', ...args);\n\nexport const checkContentsByStencilTest = (...args) =>\ncheckContents('stencil', ...args);"],"mappings":"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","ignoreList":[]}